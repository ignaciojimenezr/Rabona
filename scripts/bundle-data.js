/**
 * Build script to bundle CSV and images for Cloudflare Workers
 * Run with: node scripts/bundle-data.js
 */

import { readFileSync, readdirSync, writeFileSync } from 'node:fs';
import { join } from 'node:path';
import { fileURLToPath } from 'node:url';
import { dirname } from 'node:path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const rootDir = join(__dirname, '..');

// Helper to get MIME type from file extension
function getMimeType(filename) {
  const ext = filename.split('.').pop()?.toLowerCase();
  const mimeTypes = {
    'png': 'image/png',
    'jpg': 'image/jpeg',
    'jpeg': 'image/jpeg',
    'webp': 'image/webp',
    'svg': 'image/svg+xml',
    'gif': 'image/gif',
  };
  return mimeTypes[ext || ''] || 'application/octet-stream';
}

// Load CSV data
const csvPath = join(rootDir, 'data', 'squads_2025_26.csv');
let csvData = '';
try {
  csvData = readFileSync(csvPath, 'utf8');
  console.log(`✓ Loaded CSV data (${csvData.length} chars)`);
} catch (error) {
  console.error(`❌ Error loading CSV: ${error.message}`);
  process.exit(1);
}

// Don't bundle images - they'll be served from Assets at runtime
// This keeps the worker size under the 3 MiB free plan limit
const imageDataUris = {};
console.log(`✓ Images will be loaded from Assets at runtime (not bundled)`);

// Generate bundled-data.ts file
const outputPath = join(rootDir, 'src', 'bundled-data.ts');
const output = `/**
 * Bundled data for Cloudflare Workers
 * Auto-generated by scripts/bundle-data.js
 * DO NOT EDIT MANUALLY - regenerate with: npm run bundle-data
 * 
 * Note: Images are NOT bundled here - they're served from Assets at runtime
 * to keep worker size under the 3 MiB free plan limit.
 */

export const CSV_DATA = ${JSON.stringify(csvData)};

// Images are loaded from Assets binding at runtime, not bundled
export const IMAGE_DATA_URIS: Record<string, string> = {};
`;

writeFileSync(outputPath, output, 'utf8');
console.log(`✓ Generated ${outputPath}`);
console.log(`\n✅ Data bundling complete!`);

